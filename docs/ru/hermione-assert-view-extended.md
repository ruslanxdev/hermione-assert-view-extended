# hermione-assert-view-extended

## Обзор

Используйте плагин `hermione-assert-view-extended`, чтобы расширить возможности команды `assertView` гермионы.

Плагин позволяет снимать скриншоты с минимальными нерелевантными диффами. 

### Что такое нерелевантные диффы? 

Нередко в тестах при снятии скриншотов и их сравнении с эталонами возникают диффы, которые не имеют отношения к тесту. Диффы могут появляться из-за следующих причин:

* анимация на странице: например, анимация не успела закончиться, а тест уже делает скриншот и получившийся результат не совпадает с эталоном; дело в том, что анимация может каждый раз осуществляться по-разному, снятие скриншота может происходить с небольшой задержкой относительно предыдущего раза или наоборот раньше, чем в прошлый раз &mdash; всего этого достаточно, чтобы скриншоты показали отличие друг от друга при сравнении;

* наличие элементов в верстке, которые попадают в скриншот, но не относятся к тесту и не контролируются им, и могут быть разными в разные моменты времени в силу своей реализации;

* артефакты [анти-алиасинга][anti-aliasing], возникающие из-за сочетания определенных цветов элементов и цвета фона.

Плагин `hermione-assert-view-extended` позволяет компенсировать в значительной степени вышеперечисленные недостатки при его правильной настройке. С помощью него вы можете отключить анимацию, задать какие элементы нужно игнорировать (они будут заменены на черные прямоугольники), какие элементы сделать невидимыми, установив им нулевую непрозрачность _(opacity)_, или какие элементы спрятать. Также вы можете включить применение своего собственного CSS перед тем как делать скриншот.

### Почему нельзя просто спрятать все нерелевантные элементы?

Зачем нужны 3 варианта как исключить элемент из скриншота?

Потому что в некоторых случаях удаление элемента со страницы может приводить к нежелательному изменению верстки. То есть вы будете тестировать по сути _другую_ страницу, а не ту, которую на самом деле будет видеть ваш пользователь.

### Что еще позволяет плагин?

Ещё плагин позволяет вам задать действия, которые нужно выполнить каждый раз, перед тем как снять скриншот. Или действия, которые нужно выполнить после снятия скриншота. Для этого вам нужно указать обработчики для _beforeEach- и afterEach-_ хуков в настройках плагина.

## Установка

```bash
npm install -D hermione-assert-view-extended
```

## Настройка

Необходимо подключить плагин в разделе `plugins` конфига `hermione`:

```javascript
module.exports = {
    plugins: {
        'hermione-assert-view-extended': {
            hooks: {
                beforeEach: function(name, selector, options) {
                    return this.browser.moveTo(0, 0);
                },
                afterEach: function(name, selector, options) {
                    console.log(`Asserted view '${name}' for '${selector}' selector.`);
                }
            },
            globalStyles: {
                animationDisabled: true,
                redraw: true,
                ignoreElements: [ // Элементы страницы, которые будут заменены на черные прямоугольники
                    '.classname1'
                ],
                invisibleElements: [ // Элементы страницы, которые будут сделаны полностью прозрачными
                    '.classname3' 
                ],
                hideElements: [ // Элементы страницы, которые будут спрятаны
                    '.classname2'
                ],
                customCSS: `
                    body {
                        background-color: red;
                    }
                `
            }
        },

        // другие плагины гермионы...
    },

    // другие настройки гермионы...
};
```

### Расшифровка параметров конфигурации

| **Параметр** | **Тип** | **По&nbsp;умолчанию** | **Описание** |
| :--- | :---:| :---: | :--- |
| hooks | Object | `{ }` | Обработчики для хуков _beforeEach_ и _afterEach_, которые будут вызваны до и после снятия скриншота. |
| globalStyles | Object | `{ }` | Переопределение стилей для различных элементов. Накладывается перед снятием скриншота и снимается после снятия. |

### Параметры hooks

| **Параметр** | **Тип** | **По&nbsp;умолчанию** | **Описание** |
| :--- | :---:| :---: | :--- |
| beforeEach | Function | null | Функция-обработчик, которая будет выполняться _перед_ снятием каждого скриншота. |
| afterEach | Function | null | Функция-обработчик, которая будет выполняться _после_ снятия каждого скриншота. |

### Параметры globalStyles

| **Параметр** | **Тип** | **По&nbsp;умолчанию** | **Описание** |
| :--- | :---:| :---: | :--- |
| animationDisabled | Boolean | false | Отключить CSS-анимацию. |
| redraw | Boolean | false | Перерисовать страницу браузера после применения всех новых стилей. Также перерисовка произойдет принудительно, независимо от значения этого параметра, если задан список _redrawElements._ |
| redrawMode | String | 'medium' | Режим перерисовки: _soft, medium, hard._ См. подробности ниже. |
| redrawTimeout | Number | _N/A_ | Пауза, перед тем как перерисовать элементы страницы, в мс. |
| ignoreElements | Array | _N/A_ | Элементы страницы, которые будут заменены на черные прямоугольники. |
| invisibleElements | Array | _N/A_ | Элементы страницы, которые будут сделаны полностью прозрачными. |
| hideElements | Array | _N/A_ | Элементы страницы, которые будут спрятаны. |
| customCSS | String | _N/A_ | Собственные стили, которые будут применены перед снятием скриншота. |

### animationDisabled

Для отключения анимации применяется следующий набор стилей:

```css
    body, body *, body *:after, body *:before,
    body[class], body[class] *, body[class] *:after, body[class] *:before {
        -webkit-animation-duration: 0s !important;
        -moz-animation-duration: 0s !important;
        -ms-animation-duration: 0s !important;
        animation-duration: 0s !important;
        -webkit-transition-duration: 0s !important;
        -moz-transition-duration: 0s !important;
        -ms-transition-duration: 0s !important;
        transition-duration: 0s !important;
        -webkit-transition-delay: 0s !important;
        -moz-transition-delay: 0s !important;
        -ms-transition-delay: 0s !important;
        transition-delay: 0s !important;
    }
```

### redraw

Включает принудительную перерисовку страницы браузера после применения всех новых стилей. Также перерисовка произойдет принудительно, независимо от значения этого параметра, если задан список `redrawElements`.

### redrawMode

Режим перерисовки может принимать следующие значения:

* `soft` &mdash; перерисовать страницу без переформатирования с применением стиля `transform: translateZ(0)` ко всем элементам, заданным в параметре `redrawElements`;
* `medium` &mdash; переформатировать страницу и перерисовать её с применением стиля `opacity: 0` ко всем элементам, заданным в параметре `redrawElements`;
* `hard` &mdash; переформатировать страницу и перерисовать её с применением стиля `display: none` ко всем элементам, заданным в параметре `redrawElements`.

### redrawElements

Элементы страницы, которые нужно перерисовывать. Если элементы заданы, то перерисовка произойдет, даже если параметр `redraw` установлен в `false`. По умолчанию, массив элементов содержит `body`.

### redrawTimeout

Пауза в миллисекундах, которую должен выдержать браузер, перед тем как перерисовать элементы страницы.

### ignoreElements

Элементы страницы, которые будут заменены на черные прямоугольники. Указанный список элементов будет добавляться в список `ignoreElements` команды гермионы `assertView`, каждый раз как будет сниматься скриншот.

### invisibleElements

Элементы страницы, которые будут сделаны полностью прозрачными. Для этого к ним применяется стиль `opacity: 0 !important`.

### hideElements

Элементы страницы, которые будут спрятаны. Для этого к ним применяется стиль `display: none !important`.

### customCSS

Можно задать свои собственные стили, которые будут применены перед снятием скриншота.

## Полезные ссылки

* [Исходники плагина hermione-assert-view-extended][hermione-assert-view-extended]

[hermione-assert-view-extended]: https://github.com/ruslanxdev/hermione-assert-view-extended
[anti-aliasing]: https://ru.wikipedia.org/wiki/Экранное_сглаживание
